=== ðŸ¤– Orchestrator 4.0 Context Bridge ===
You are an Actentic Worker in the Orchestrator 4.0 Factory.
Mode: [VERBOSE]
Your role is defined in the workflow below.

--- [ 1. The Mission ] ---
# Task Board: Estimate Generation & Delivery Runtime

- Project: SnapQuote
- Version: v1.1 (Hotfix)
- Date: 2026-02-20
- Status: V1 complete; V2 core API rollout complete (TB-10/TB-12/TB-13/TB-18); V3 TB-15/TB-17 complete

## Develop Loop Init (Orchestrator 4.1)

- Current mission: Resolve Critic high-priority API/Data issue (duplicate payment link risk) under locked contract.
- Recommended model: `[LIGHT]` (API handler hardening + test update, bounded scope).
- Active agents:
  - Orchestrator (contract check and board control)
  - Backend Thread A (API Builder)
  - Critic (post-fix audit)
  - Secretary (history + daily log updates)

## Mission Resolution

- `Mission` section in `.agent/memory/codex_context.txt` is empty.
- Fallback applied: execute required Architect workflow artifacts from Rule 3 (task board + locked API spec + critique + daily log).

## Phase Checklist

- [x] 0. Intelligence setup and context scan complete.
- [x] 1. Goal alignment complete (`conductor/product.md` reviewed).
- [x] 2. Blueprint drafted for runtime API surface.
- [x] 3. Runtime API spec generated and locked in `docs/api-spec.md`.
- [x] 4. Strategic audit documented in `.agent/memory/agent_debate.md`.
- [x] 5. Presentation package prepared for user sign-off.

## Runtime Tasks

| Task ID | Task | Endpoint(s) | Owner | Status |
|:--|:--|:--|:--|:--|
| TB-01 | Public audio transcription for no-login and logged-in flows | `POST /api/transcribe` | Backend | Complete |
| TB-02 | Public estimate generation from notes/images | `POST /api/generate` | Backend | Complete |
| TB-03 | Optional-auth estimate delivery by email with PDF support | `POST /api/send-email` | Backend | Complete |
| TB-04 | Authenticated Stripe payment link creation in tenant connected account | `POST /api/create-payment-link` | Backend | Complete |
| TB-05 | Payment settlement sync from Stripe to estimate status | `POST /api/webhooks/stripe` | Backend | Complete |
| TB-06 | Backfill/reconcile paid Stripe sessions | `GET/POST /api/webhooks/stripe/reconcile` | Backend | Complete |
| TB-07 | Authenticated usage and quota visibility | `GET /api/billing/usage` | Backend | Complete |
| TB-08 | Tenant Stripe Connect onboarding + status + dashboard management | `POST /api/stripe/connect/onboard`, `GET /api/stripe/connect/status`, `POST /api/stripe/connect/dashboard-link` | Backend + Frontend | Complete |
| TB-09 | Authenticated local paid status probe for sent estimates | `GET /api/payments/stripe/status` | Backend + Frontend | Complete |
| TB-14 | SaaS subscription billing (checkout/portal/status + webhook sync) | `POST /api/billing/stripe/checkout`, `POST /api/billing/stripe/portal`, `GET /api/billing/subscription`, `POST /api/webhooks/stripe/billing` | Backend + Frontend | Complete |

## Cross-Checks

- Every runtime task maps to at least one endpoint in `docs/api-spec.md`.
- Public contract endpoints (`transcribe`, `generate`, `send-email`, `create-payment-link`, `payments/stripe/status`, `stripe/connect/*`) match the hotfix contract in Context Bridge section [2].
- Internal payment reliability endpoints (`webhooks/stripe`, `webhooks/stripe/reconcile`) are documented as operational, non-public contract routes.

## Lock Rule

- Spec state: `LOCKED`.
- Rule: no implementation changes without updating `docs/api-spec.md` first.

## Develop Execution (2026-02-20)

- [x] 0. Orchestrator setup: contract check + board init completed.
- [x] 1A. Backend Thread: payment-link idempotency hardening implemented.
- [x] 1B. Frontend Thread: added `/payment-success` route to close Stripe redirect UX gap (no API contract delta).
- [x] 2. Critic reflexion: issue classified and re-audited in `.agent/memory/agent_debate.md`.
- [x] 3. Specialist dispatch: API/Data fix applied and verified by lint + test updates.
- [x] 4. Secretary docs: feature history EN/KR updated.
- [x] 5A. QA guard: regression suite passes on Node 20 after loader/script compatibility fix.
- [x] 5B. CISO external scanner: processed user-provided `npm audit` report and executed dependency patch workflow.

## Fix Loop Init (Orchestrator 4.1)

- Bug focus: dependency security vulnerabilities from `npm audit` (34 issues reported, including high severity items).
- Recommended model: `[HEAVY]` (supply-chain patching across config, dependencies, and client import path).
- Active agents:
  - Orchestrator (bug triage + board state)
  - Lead Dev (reproduction and patch)
  - Security Specialist Dispatch (`vulnerability-scanner`, `api-security-best-practices` equivalent workflow)
  - Critic (regression shield)
  - Secretary (history/findings/daily log)

## Fix Execution (2026-02-20)

- [x] 0. Intelligence setup: audit report classified as Security patch scope.
- [x] 1. Reproduction: red state confirmed from provided `npm audit report`.
- [x] 2. Specialist dispatch (Security):
  - Removed `xlsx` usage from import flow by converting to secure CSV-only parser.
  - Removed `next-pwa` integration and switched to manual service worker registration.
  - Added Next image optimizer mitigation in `next.config.mjs` (`images.unoptimized`, empty `remotePatterns`).
- [x] 3. Critic regression shield: fix reviewed and recorded in `.agent/memory/agent_debate.md`.
- [x] 4. Secretary docs: feature history EN/KR updated, root cause documented in `findings.md`.
- [x] 5A. QA final guard: `npm test` and `npm run lint` green (existing lint warning unchanged).
- [x] 5B. Tracks log: `conductor/tracks.md` updated.

## Develop Execution (2026-02-24) - Guest Paid Reflection Closure

- [x] 0. Contract update first: `docs/api-spec.md` extended with `GET /api/payments/stripe/status`.
- [x] 1A. Backend Thread: implemented Stripe payment status probe route with validation + rate limit.
- [x] 1B. Frontend Thread: persisted `paymentLinkId` in local estimate lifecycle and added history auto-sync (`sent -> paid`).
- [x] 2. Critic reflexion: documented API/Data risk closure in `.agent/memory/agent_debate.md`.
- [x] 3. Specialist dispatch: tests added for new route (`tests/api/stripe-routes.test.mjs`).
- [x] 4. Secretary docs: feature history EN/KR + daily log updated.
- [x] 5A. QA guard: `npm test` and `npm run lint` pass.
- [x] 5B. Build guard: blocker resolved on 2026-02-25 via TB-11 recovery (historical note retained).

## Develop Execution (2026-02-24) - Stripe Connect Tenant Ownership

- [x] 0. Contract update first: auth/payment model updated in `docs/api-spec.md` (Connect endpoints + auth requirement changes).
- [x] 1A. Backend Thread: implemented Stripe Connect onboarding/status/dashboard-link routes.
- [x] 1B. Backend Thread: migrated payment-link route to authenticated tenant connected-account creation (`stripeAccount`).
- [x] 2. Frontend Thread: added Stripe Connect management UI on profile and linked payment-link UX error guidance.
- [x] 3. Critic reflexion: recorded architecture correction and risk closure in `.agent/memory/agent_debate.md`.
- [x] 4. Specialist dispatch: expanded mocks/tests for Connect + payment constraints (`tests/api/stripe-connect-routes.test.mjs`, `tests/api/core-workflow-routes.test.mjs`).
- [x] 5A. QA guard: `npm test` and `npm run lint` pass (one pre-existing lint warning remains).
- [x] 5B. Build guard: `ELOOP` blocker resolved on 2026-02-25 (see TB-11 execution).

## Architecture V2 Init (Orchestrator 4.1)

- Project: SnapQuote V2 (The Lazy Capture Expansion & System Hardening)
- Focus: Gemini Multimodal AI Integration, Sync Resilience, CI/CD Fixes, Comms Monetization.
- Recommended model: `[HEAVY]` (architecture contract planning + system scope updates).
- Active agents:
  - Orchestrator (contract and board control)
  - Architect (runtime API contract expansion)
  - Critic (strategic audit and risk screening)
  - Secretary (history + daily log updates)

### Runtime Tasks (V2)

| Task ID | Task | Endpoint(s) | Owner | Status |
|:--|:--|:--|:--|:--|
| TB-10 | Gemini API integration for multimodal "Capture First" parsing | `POST /api/generate` (Switch engine) | Backend | Complete |
| TB-11 | CI/CD ELOOP build fix (`GEMINI.md` symlink cleanup) | N/A (Build Config) | DevOps | Complete |
| TB-12 | Conflict-Free Replicated Data Type (CRDT) for offline sync | `POST /api/sync/crdt` (New) | Backend | Complete |
| TB-13 | SMS monetization strategy shift (Email primary, Twilio Pay-as-you-go) | `POST /api/send-sms` (New/Premium) | Backend | Complete |
| TB-18 | In-app feedback capture API + widget wiring | `POST /api/feedback` (New) | Backend + Frontend | Complete |
| TB-14 | SaaS subscription billing for service monetization | `POST /api/billing/stripe/checkout`, `POST /api/billing/stripe/portal`, `GET /api/billing/subscription`, `POST /api/webhooks/stripe/billing` | Backend + Frontend | Complete |

## Launch Execution (2026-02-25) - Architecture V2 Planning

- [x] 0. Intelligence setup: architecture complexity classified as `[HEAVY]`.
- [x] 1. Goal alignment: `conductor/product.md` and `conductor/tech-stack.md` validated for V2 scope.
- [x] 2. Blueprinting: V2 tasks (`TB-10` to `TB-13`) documented in runtime board.
- [x] 3. Runtime API spec: `docs/api-spec.md` updated and locked with V2 endpoint surface.
- [x] 4. Critic audit: strategic risks and constraints documented in `.agent/memory/agent_debate.md`.
- [x] 5. Final sign-off: user approval received on 2026-02-27; implementation sequence unlocked.

## V2 Execution Queue (Post Sign-off)

- Priority lock:
  - 1) TB-10 (`POST /api/generate` Gemini engine switch)
  - 2) TB-12 (`POST /api/sync/crdt`)
  - 3) TB-13 (`POST /api/send-sms`)
- Execution result (2026-02-28):
  - TB-10 complete
  - TB-12 complete
  - TB-13 complete
- Constraint: `docs/api-spec.md` remains `LOCKED`; any contract delta must be updated first.

## Develop Execution (2026-02-27) - V2 Final Sign-off Closure

- [x] 0. Contract check: confirmed `docs/api-spec.md` exists and remains `LOCKED`.
- [x] 1. Board control: closed pending V2 final sign-off gate and synchronized stale unresolved marker.
- [x] 2. Critic reflexion: recorded governance closure verdict in `.agent/memory/agent_debate.md`.
- [x] 3. Secretary docs: appended records to `feature_history_en.md`, `feature_history_kr.md`, and daily log.
- [x] 4A. QA guard: `npm run lint` pass (one pre-existing warning), `npm test` pass (58/58).
- [x] 4B. CISO guard: `npm audit` blocked by network DNS (`ENOTFOUND registry.npmjs.org`); fallback static scan showed no hardcoded secret/eval/DOM-injection patterns in runtime paths.

## V2 Cross-Checks

- Every V2 task (`TB-10` to `TB-13`, `TB-18`) maps to at least one endpoint or ops scope in `docs/api-spec.md`.
- V2 additions preserve lock rule: implementation must follow contract updates first.

## Develop Execution (2026-02-25) - TB-11 Build Guard Recovery

- [x] 0. Reproduction: `next build` failed with `ELOOP` on workspace-root `GEMINI.md` symlink.
- [x] 1. Build Config fix: replaced looping symlink with regular `GEMINI.md` file.
- [x] 2. Type gate fix: aligned Supabase helper typing in `lib/server/stripe-connect.ts` to restore production type-check path.
- [x] 3. Scope gate fix: excluded non-runtime skill workspace (`codex`, `.agent`) from `tsconfig.json` build type scope.
- [x] 4. Frontend SSR gate: removed `useSearchParams` reliance from `/login` and `/new-estimate` to satisfy static prerender constraints.
- [x] 5A. QA guard: `npm run lint` and `npm test -- --runInBand` pass (single pre-existing lint warning unchanged).
- [x] 5B. Build guard: `npm run build` passes successfully.

## Develop Execution (2026-02-25) - TB-14 SaaS Subscription Billing

- [x] 0. Contract update first: `docs/api-spec.md` extended with Stripe Billing SaaS endpoints and webhook contract.
- [x] 1A. Backend Thread: implemented billing routes (`/api/billing/stripe/checkout`, `/api/billing/stripe/portal`, `/api/billing/subscription`).
- [x] 1B. Backend Thread: implemented billing webhook route (`/api/webhooks/stripe/billing`) with plan-tier synchronization.
- [x] 2. Database Thread: added profile billing columns migration (`supabase/migrations/20260225150000_add_stripe_billing_to_profiles.sql`).
- [x] 3. Frontend Thread: connected `/pricing` upgrade CTA to Stripe Checkout and billing management portal flow.
- [x] 4. Specialist dispatch: expanded Stripe mocks and added API tests (`tests/api/billing-subscription-routes.test.mjs`).
- [x] 5A. QA guard: `npm run lint` and `npm test -- --runInBand` pass (single pre-existing lint warning unchanged).
- [x] 5B. Build guard: `npm run build` passes with new billing routes included.

## Architecture V3 Init (Orchestrator 4.1)

- Project: SnapQuote V3 (Painkiller Upsells Expansion)
- Focus: Quote Recovery Copilot (Pro) and Dynamic Pricing Engine (Enterprise).
- Recommended model: `[HEAVY]` (architecture contract planning + system scope updates).
- Active agents:
  - Orchestrator (contract and board control)
  - Architect (runtime API contract expansion)
  - Critic (strategic audit and risk screening)
  - Secretary (history + daily log updates)

### Runtime Tasks (V3)

| Task ID | Task | Endpoint(s) | Owner | Status |
|:--|:--|:--|:--|:--|
| TB-10 | Gemini Multimodal Expansion (Images + Voice) | `POST /api/generate` | Fullstack | Complete |
| TB-15 | Quote Recovery Copilot logic and cron queue | `POST /api/quotes/recovery/trigger` | Backend | Complete |
| TB-16 | Dynamic Pricing Engine markup and rule evaluation | `POST /api/pricing/dynamic/calculate` | Backend | Backlog |
| TB-17 | Social Login (Google/Apple) & 3-Step Setup Wizard | `GET /auth/callback` | Fullstack | Complete |
| TB-18 | In-App Feedback & Bug Reporting Widget | `POST /api/feedback` | Fullstack | Complete |
| TB-19 | Good-Better-Best Generator (Auto-Upsell) | `POST /api/generate` | AI/Backend | Complete |
| TB-20 | Auth Redirect & Sync Reliability Overhaul | N/A (Client Runtime) | Fullstack | Complete |

## Develop Execution (2026-03-01) - TB-20 Auth Redirect & Sync Reliability

- [x] 0. Strategy Selection: implemented "Force-Reload" strategy for 100% reliable auth transitions.
- [x] 1A. Frontend Thread: created `AuthRedirectManager` and integrated into root `layout.tsx`.
- [x] 1B. Frontend Thread: updated `useAuthGuard` and `SyncManager` to remove fragmented listeners and use `window.location.href`.
- [x] 2A. Database Thread: updated IndexedDB schema and `LocalEstimate` typing to include `updatedAt`.
- [x] 2B. Sync Thread: refactored `syncEstimates` logic to use "Last Write Wins" via `updatedAt` metadata comparison.
- [x] 3. Critic reflexion: documented choice of `window.location.href` vs client-side routing in `.agent/memory/agent_debate.md`.
- [x] 4. Secretary docs: updated `docs/api-spec.md` with Global Auth Management section.
- [x] 5. QA guard: verified login/logout flow across all protected routes.
## Develop Execution (2026-02-27) - TB-17 Social Login (Google PKCE)

- [x] 0. Contract check: confirmed `GET /auth/callback` exists in locked `docs/api-spec.md` (no contract delta required).
- [x] 1A. Frontend Thread: added social auth entry point on `/login` with Google OAuth dispatch and callback redirect wiring.
- [x] 1B. Fullstack Thread: implemented `app/auth/callback/page.tsx` to exchange PKCE code, sanitize redirect targets, and propagate OAuth errors safely to login.
- [x] 2. Specialist dispatch (API/Data + Security hygiene): extracted shared callback normalization helpers in `lib/auth/oauth-callback.ts` (next path / intent / error normalization).
- [x] 3. Verification: added tests `tests/api/oauth-callback-utils.test.mjs`; `npm test` pass (63/63), `npm run lint` pass (one pre-existing warning unchanged).
- [x] 4. Build guard: rerun on 2026-02-28 passes after replacing root `GEMINI.md` symlink with a regular file.

## Develop Execution (2026-02-28) - TB-17 Setup Wizard & Apple Login
- [x] 1. Re-added Apple Login to `app/login/page.tsx`.
- [x] 2. Built `components/setup-wizard.tsx` to collect `business_name` and `default_tax_rate` upon first login.
- [x] 3. Conditionally rendered the wizard in `app/page.tsx` replacing the main dashboard until profile completion.
- [x] 4. Resolved TypeScript and strict null check errors.

~~## Scope Adjustment (2026-02-28) - TB-17 Apple Login Removal~~
~~- [x] Product decision: removed Apple OAuth sign-in and retained Google OAuth + magic link flow.~~
~~- [x] Contract sync: `/auth/callback` description updated to Google-only OAuth PKCE handling in `docs/api-spec.md`.~~
~~- [x] Frontend sync: removed Apple button/provider dispatch from `app/login/page.tsx`.~~
~~- [x] Verification: regression (`npm test`) and lint (`npm run lint`) pass.~~

## Develop Execution (2026-02-28) - TB-12 CRDT Sync Endpoint

- [x] 0. Contract check: confirmed `POST /api/sync/crdt` exists in locked `docs/api-spec.md` (no contract delta required).
- [x] 1A. Backend Thread: implemented `app/api/sync/crdt/route.ts` with auth guard, payload validation, dedup merge, and upsert to `sync_change_log`.
- [x] 1B. Database Thread: added migration `supabase/migrations/20260228100000_add_sync_change_log_and_feedback_metadata.sql` for `sync_change_log` + indexes + RLS.
- [x] 2. Specialist dispatch (API/Data): added deterministic merge/upsert tests in `tests/api/sync-and-feedback-routes.test.mjs`.
- [x] 3. Verification: `npm test` pass (71/71), `npm run lint` pass (single pre-existing warning unchanged).
- [x] 4. Build guard: `npm run build` passes after workspace-root `GEMINI.md` symlink cleanup.

## Develop Execution (2026-02-28) - TB-18 Feedback API + Widget Wiring

- [x] 0. Contract check: confirmed `POST /api/feedback` exists in locked `docs/api-spec.md` (no contract delta required).
- [x] 1A. Backend Thread: implemented `app/api/feedback/route.ts` with optional auth, payload validation, and IP rate limit.
- [x] 1B. Frontend Thread: rewired `components/feedback-modal.tsx` to call `/api/feedback` instead of direct client-side table insert.
- [x] 2. Database Thread: extended `feedback` table with `metadata jsonb` in migration `20260228100000_add_sync_change_log_and_feedback_metadata.sql`.
- [x] 3. Specialist dispatch (API/Data + Security hygiene): added route coverage for guest/auth/rate-limit paths in `tests/api/sync-and-feedback-routes.test.mjs`.
- [x] 4. Verification: `npm test` pass (71/71), `npm run lint` pass (single pre-existing warning unchanged).
- [x] 5A. Build guard: `npm run build` passes after workspace-root `GEMINI.md` symlink cleanup.
- [ ] 5B. CISO guard: `npm audit` blocked by network DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

## Develop Execution (2026-02-28) - TB-10 Gemini Engine Switch (`POST /api/generate`)

- [x] 0. Contract check: confirmed `POST /api/generate` remains contract-compatible (response schema unchanged).
- [x] 1A. Backend Thread: switched runtime generation to Gemini-first strategy (`GEMINI_API_KEY` present) with OpenAI fallback path for compatibility.
- [x] 1B. Backend Thread: added Gemini response parsing + usage token extraction while preserving existing estimate normalization and quota recording flow.
- [x] 2. Specialist dispatch (API/Data): extended tests to cover Gemini provider path while preserving OpenAI mock path.
- [x] 3. Verification: `npm test` pass (77/77), `npm run lint` pass (single pre-existing warning unchanged), `npm run build` pass.
- [ ] 4. CISO guard: `npm audit` blocked by network DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

## Develop Execution (2026-02-28) - TB-13 SMS Delivery API (`POST /api/send-sms`)

- [x] 0. Contract check: confirmed `POST /api/send-sms` exists in locked `docs/api-spec.md`.
- [x] 1A. Backend Thread: implemented `app/api/send-sms/route.ts` with auth, validation, rate limit, credit balance check, and Twilio provider dispatch.
- [x] 1B. Backend Thread: persisted send records to `sms_messages` and ledger deduction to `sms_credit_ledger` on successful provider response.
- [x] 2. Specialist dispatch (API/Data): added route tests for unauthorized/invalid/insufficient-credit/rate-limit/success paths in `tests/api/send-sms-routes.test.mjs`.
- [x] 3. Verification: `npm test` pass (77/77), `npm run lint` pass (single pre-existing warning unchanged), `npm run build` pass.
- [ ] 4. CISO guard: `npm audit` blocked by network DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

## Develop Execution (2026-02-28) - TB-15 Quote Recovery Copilot

- [x] 0. Contract check: confirmed `POST /api/quotes/recovery/trigger` exists in locked `docs/api-spec.md` (no contract delta required).
- [x] 1A. Backend Thread: implemented `app/api/quotes/recovery/trigger/route.ts` with 48h candidate scan, claim lock (`first_followup_queued_at`), and Gemini-first follow-up message generation.
- [x] 1B. Backend Thread: integrated delivery dispatch by channel (Twilio SMS with credit gating, Resend email fallback, `skipped_no_contact` path).
- [x] 2. Database Thread: no schema delta required; reused existing follow-up tracking columns (`sent_at`, `first_followup_queued_at`, `first_followed_up_at`, `last_followed_up_at`).
- [x] 3. Specialist dispatch (API/Data): added route tests in `tests/api/quote-recovery-routes.test.mjs` for auth/plan-tier/dryRun/sms/email/cron/rate-limit paths.
- [x] 4A. QA guard: `npm test` pass (85/85), `npm run lint` pass (0 warnings/errors).
- [x] 4B. Build guard: `npm run build` pass.
- [ ] 4C. CISO guard: `npm audit` blocked by network DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

## Develop Execution (2026-03-01) - TB-19 Auto-Upsell Generator

- [x] 0. Contract check: verified `POST /api/generate` includes `upsellOptions` in `docs/api-spec.md`.
- [x] 1A. AI Thread: updated Gemini/OpenAI generation prompt in `app/api/generate/route.ts` to generate `better` and `best` upsell options.
- [x] 1B. AI Thread: structured output normalization enforces `upsellOptions` shape (`tier/title/description/addedItems`) with empty-item filtering.
- [x] 2A. Frontend Thread: updated `app/new-estimate/page.tsx` to parse/render auto-upsell packages and allow one-click package apply into estimate items.
- [x] 2B. Data Thread: extended local estimate typing in `lib/estimates-storage.ts` and persisted optional `upsellOptions` in draft/sent payload.
- [x] 3. Specialist dispatch (API/Data): updated `tests/api/core-workflow-routes.test.mjs` to verify upsell normalization (`tier` fallback + empty package filtering).
- [x] 4A. QA guard: `npm test` pass (85/85), `npm run lint` pass (0 warnings/errors), `npm run build` pass.
- [ ] 4B. CISO guard: `npm audit` blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current environment; fallback static scan found no `eval`/`new Function`/`dangerouslySetInnerHTML` usage in TB-19 touched files.

--- [ 1.5 System Architecture & Docs ] ---

--- [ 1.8 Strategic Debate Log ] ---
# Strategic Audit: Estimate Generation and Delivery Runtime (v1.1)

Date: 2026-02-20

## Critic Findings

1. High risk: no idempotency key is used in `POST /api/create-payment-link`.
- Impact: repeated client retries can create multiple Stripe payment links for one estimate.
- Recommendation: add an idempotency strategy keyed by `estimateId + amount + userId`.

2. Medium risk: guest traffic on `transcribe` and `generate` has no durable quota identity.
- Impact: abuse control is IP-limited, which is weaker behind NAT/proxy clusters.
- Recommendation: add signed anonymous session IDs or captcha gate for sustained guest usage.

3. Medium risk: webhook success path depends on metadata quality.
- Impact: missing `estimateId` and `estimateNumber` causes paid sessions that cannot be linked.
- Recommendation: enforce metadata presence at payment-link creation and add monitoring threshold alerts.

4. Low risk: mixed error payload shapes across runtime endpoints.
- Impact: frontend error handling must branch for string, structured, and success-flag error forms.
- Recommendation: standardize on one error envelope in v1.2.

## Debate Conclusion

- The runtime is deployable with current behavior, but payment correctness relies on metadata discipline and reconcile jobs.
- Contract is acceptable for v1.1 hotfix if operations run reconcile and monitor alerts.
- Spec is locked, with follow-up improvements deferred to a planned v1.2 normalization pass.

## Develop Loop Reflexion (2026-02-20)

Issue classification:
- Type: API/Data
- Priority: High
- Signal: duplicate payment-link creation risk due missing idempotency handling.

Dispatch:
- Skill family applied: `api-design-principles` (contract-safe backend hardening).
- Fix: added Stripe request idempotency support in `POST /api/create-payment-link`.
  - Use client header `Idempotency-Key` when present.
  - Otherwise generate deterministic key from `userId + estimate reference + amount`.

Verification:
- Added test coverage for deterministic idempotency key behavior.
- Added test coverage for client header override behavior.
- Contract note added in `docs/api-spec.md`.
- Node 20 compatibility fix applied to test runner (`tests/loader.mjs`, `package.json`), and `npm test` now passes.
- `npm run lint` passes (one pre-existing React hook warning outside this fix scope).
- External vulnerability scanner (`npm audit`) could not reach npm registry due network restriction; local static grep-based scan found no hardcoded secret or obvious dynamic-code risk patterns.

Resolution status:
- High-priority API/Data issue: Resolved.
- Remaining medium/low items from prior audit: Open (planned for v1.2).

## Fix Loop Debate: Dependency Security Patch (2026-02-20)

Issue classification:
- Type: Security / Supply-chain dependency risk.
- Priority: High (multiple high-severity advisories from `npm audit`).

Root-cause pattern:
- High-risk/no-fix package in direct runtime dependency (`xlsx`).
- Vulnerable transitive chain introduced by `next-pwa` (workbox/del/glob/minimatch path).
- Framework-level advisory on current Next major line.

Implemented patch set:
- Replaced Excel parser with CSV-only parser in `components/excel-import-modal.tsx` to remove `xlsx` runtime dependency.
- Removed `next-pwa` wrapper from `next.config.mjs`; switched to app-owned service worker registration and static `public/sw.js`.
- Added defensive Next image config in `next.config.mjs`:
  - `images.unoptimized = true`
  - `images.remotePatterns = []`

Regression check:
- `npm test`: pass (36/36).
- `npm run lint`: pass (single pre-existing hook dependency warning remains).
- `npm prune --no-audit --no-fund`: pass; extraneous `next-pwa`/`xlsx` removed from installed tree.
- `npm ls next-pwa xlsx --depth=2`: empty after prune.

Critic verdict:
- Not a band-aid for `xlsx`/`next-pwa` chain; direct attack surface reduced by removing vulnerable direct dependencies.
- Residual risk remains for Next advisory until major framework upgrade and fresh lockfile re-resolution in network-enabled CI.

## Frontend Thread Closure (2026-02-24)

Issue classification:
- Type: UX / Runtime reliability.
- Priority: Medium.
- Signal: Stripe `after_completion.redirect` points to `/payment-success`, but route was missing and could return 404 after checkout.

Dispatch:
- Added `app/payment-success/page.tsx` for a dedicated post-checkout confirmation surface.
- Included immediate user actions (`/history`, `/new-estimate`) and an explicit note about webhook/reconcile eventual consistency.
- Kept API contract unchanged (`docs/api-spec.md` remains locked with no endpoint delta).

Critic verdict:
- Checkout completion flow is now closed on frontend and no longer depends on undefined route behavior.
- Remaining operational dependency: webhook secret correctness and reconcile scheduling still required for paid-state consistency.

## Develop Loop Reflexion (2026-02-24) - Guest Paid Status Sync

Issue classification:
- Type: API/Data
- Priority: High
- Signal: guest/no-login flow could complete Stripe checkout but local history remained `sent` because status updates depended on authenticated cloud sync.

Dispatch:
- Contract-first update in `docs/api-spec.md`:
  - Added `GET /api/payments/stripe/status` as optional-auth public endpoint for paid status probing.
- Backend:
  - Added `app/api/payments/stripe/status/route.ts`.
  - Implemented rate limiting, query validation, Stripe checkout session scan by `paymentLinkId`, metadata resolution fallback via payment intent, and Stripe auth error mapping.
  - Enhanced `POST /api/create-payment-link` redirect URL builder to preserve estimate context (`estimateId`, `estimateNumber`) on `/payment-success`.
- Frontend/data:
  - Persisted payment-link tracking metadata in local estimate model (`paymentLink`, `paymentLinkId`, `paymentLinkType`, payment sync markers).
  - Updated `app/new-estimate/page.tsx` to persist payment link id and ensure email-send success writes/updates local estimate to `sent` even when draft was not manually saved.
  - Updated `app/history/page.tsx` to poll payment status for sent estimates with `paymentLinkId` and auto-transition to `paid`.

Verification:
- Added route tests in `tests/api/stripe-routes.test.mjs`:
  - missing `paymentLinkId` validation
  - unpaid vs paid status detection
  - Stripe authentication error path
- Ran regression: `npm test` pass (41 tests).
- Ran lint: `npm run lint` pass (one pre-existing hook dependency warning unchanged).
- Attempted build: blocked by pre-existing filesystem symlink loop (`ELOOP` at `GEMINI.md`), unrelated to this patch scope.

Resolution status:
- Guest payment completion visibility gap: Resolved.
- Operational dependencies unchanged: webhook/reconcile remain required for server-of-record consistency.

## Develop Loop Reflexion (2026-02-24) - Multi-Tenant Stripe Connect Pivot

Issue classification:
- Type: API/Data + Product Architecture
- Priority: High
- Signal: platform-level Stripe secret flow made the operator the payment owner, which breaks true SaaS tenant ownership for contractors/company representatives.

Dispatch:
- Contract-first updates:
  - `POST /api/create-payment-link` auth requirement restored.
  - Added Stripe Connect runtime endpoints:
    - `POST /api/stripe/connect/onboard`
    - `GET /api/stripe/connect/status`
    - `POST /api/stripe/connect/dashboard-link`
  - `GET /api/payments/stripe/status` moved to authenticated payment domain.
- Backend implementation:
  - Added Stripe Connect service helper (`lib/server/stripe-connect.ts`) and profile schema migration for connected-account fields.
  - Updated payment-link creation to require authenticated user + linked Stripe account and to create links under `stripeAccount`.
  - Added onboarding/status/dashboard-link APIs for each tenant to self-manage payment operations.
  - Added estimate context params to payment success redirect.
- Frontend implementation:
  - Added Stripe Connect status/connect/manage section in `app/profile/page.tsx`.
  - Updated payment-link generation UX in estimate and quick-quote flows with Connect-specific guidance on 401/403 responses.
  - Preserved local paid-sync loop while moving payment status probe to authenticated access.

Verification:
- Extended mocks for Stripe Connect account APIs.
- Updated payment-link route tests for authenticated connected-account behavior.
- Added dedicated connect route tests (`tests/api/stripe-connect-routes.test.mjs`).
- Full regression: `npm test` pass (49 tests).
- Lint: pass, with one pre-existing warning outside this scope.

Resolution status:
- Tenant payment ownership model: Resolved (Connect-based).
- Remaining operational work: rollout migration in deployed Supabase and provision production Connect settings.

## Debate Session: Architecture V2 Launch (2026-02-25)

**Subject**: Upgrading Core Engine to Gemini Multimodal & System Hardening
**Context**: "Capture-First" UX demands real-time processing of messy field recordings and imagery. Concurrently, offline sync (CRDT) and comms (SMS) need business decoupling to control costs.

### Critic (Strategic Audit)
1. **Gemini Engine Switch (`POST /api/generate`)**:
   - **Pro**: Gemini's massive context window and multimodal ingestion natively support the "Dump Bucket" UX (TB-10). It can process photos of job sites alongside audio transcripts without hitting standard token cliffs.
   - **Risk**: Moving away from the current tested OpenAI Prompt V5 Lite format parsing. We must ensure Gemini outputs strictly matching JSON schema (`EstimateItem[]`, `EstimateSection[]`).
   - **Verdict**: HIGH VALUE. The competitive advantage of image+audio "lazy capture" heavily outweighs the switch cost. Must use strict structured output mode for Gemini.

2. **Sync Conflict Resolution (`POST /api/sync/crdt`)**:
   - **Critique**: Moving from Last-Write-Wins to CRDT (TB-12) is historically difficult on standard relational DBs (Supabase Postgres).
   - **Verdict**: NECESSARY BUT COMPLEX. We should start with a timestamp-based vector clock per record before attempting full operational transformation (OT) or Yjs/CRDT.

3. **SMS Monetization (`POST /api/send-sms`)**:
   - **Critique**: Current $19 Pro Plan cannot sustain automated Twilio SMS campaigns due to variable per-msg fees and A2P 10DLC registration blockers.
   - **Verdict**: APPROVED. Refactoring to a credit-based system (Pay-as-you-go) protects margins, while leaving Email fallback as the primary "free" automation channel.

4. **CI/CD Build Blocker (`GEMINI.md` ELOOP)**:
   - **Verdict**: Banal but critical. TB-11 must be executed immediately to restore continuous deployment pipeline integrity.

## Fix Loop Debate: Database Security Patch (2026-02-25)

**Issue classification**:
- Type: Security / Performance Risk
- Priority: High
- Signal: Static analysis of `supabase_schema_fresh.sql` revealed missing foreign key indexes, over-permissive public insert policies on referral tables, and missing RLS documentation for ops tables.

**Implemented patch set**:
- Added missing B-Tree indexes for `estimate_items(estimate_id)`, `automations(user_id)`, `job_queue(user_id)`, and `feedback(user_id)` to prevent cascade delete locks and slow sequential scans.
- Removed `Anyone can insert referral events` RLS policy to patch a DDoS/storage bloat vulnerability (events should be inserted via Edge Functions using Service Role).
- Removed duplicate unique index on `estimate_attachments(estimate_id)`.
- Replaced `to authenticated` with `to public` (no role restriction) for `pricing_experiments` select policy so unauthenticated visitors can view A/B pricing structures.

**Critic verdict**:
- **PASS**: Fixes are structurally sound. The foreign key indexes are strictly necessary for Postgres performance under scale, and locking down public inserts prevents malicious database inflation. No application logic regressions expected since the application tier operates under matching scopes.

## Launch Workflow Closure (2026-02-25)

Issue classification:
- Type: Architecture / Contract planning.
- Priority: High.
- Signal: user requested strict execution of Launch workflow artifacts before V2 implementation.

Dispatch:
- Re-validated board/spec/debate linkage against lock rule.
- Hardened `docs/api-spec.md` V2 sections with explicit rate limits, error envelopes, and runtime table requirements for `sync/crdt` and `send-sms`.
- Corrected task mapping gap by adding `TB-09` to the contract verification matrix.

Critic verdict:
- Launch-phase artifacts are coherent and internally consistent for V2 sign-off.
- Implementation should start only after user approves V2 sequence priority (`TB-10` vs `TB-11` first).

## Develop Loop Reflexion (2026-02-25) - TB-11 Build Guard Recovery

Issue classification:
- Type: Build / CI reliability.
- Priority: High.
- Signal: production build blocked by `ELOOP` at workspace root (`GEMINI.md`) and follow-on type/prerender blockers.

Dispatch:
- Replaced looping `GEMINI.md` symlink with a regular file to remove filesystem recursion.
- Fixed Supabase helper type contract in `lib/server/stripe-connect.ts` by using explicit `SupabaseClient` typing.
- Reduced type-check scope by excluding non-runtime workspace folders (`codex`, `.agent`) in `tsconfig.json`.
- Removed `useSearchParams` dependency from `app/login/page.tsx` and `app/new-estimate/page.tsx` (replaced with `window.location.search` parsing) to satisfy Next static prerender constraints.

Verification:
- `npm run build`: pass.
- `npm run lint`: pass (one pre-existing `react-hooks/exhaustive-deps` warning remains in `components/automation/automation-settings.tsx`).
- `npm test -- --runInBand`: pass (49/49).

Resolution status:
- TB-11 build blocker: Resolved.
- Next implementation candidate: TB-10 (Gemini engine switch for `POST /api/generate`).

## Develop Loop Reflexion (2026-02-25) - TB-14 SaaS Subscription Billing

Issue classification:
- Type: API/Data + Product Monetization.
- Priority: High.
- Signal: product already supports tenant quote-payment collection (Stripe Connect), but lacked platform-owned SaaS subscription charging for service usage.

Dispatch:
- Contract-first update:
  - Added SaaS billing endpoints:
    - `POST /api/billing/stripe/checkout`
    - `POST /api/billing/stripe/portal`
    - `GET /api/billing/subscription`
    - `POST /api/webhooks/stripe/billing`
  - Extended error matrix + DB/runtime mapping in `docs/api-spec.md`.
- Database:
  - Added billing linkage columns to `profiles` via migration:
    - `stripe_customer_id`
    - `stripe_subscription_id`
    - `stripe_subscription_status`
    - `stripe_subscription_price_id`
    - `stripe_subscription_current_period_end`
    - `stripe_cancel_at_period_end`
    - `stripe_subscription_updated_at`
- Backend:
  - Implemented checkout session creation with authenticated user mapping and Stripe customer bootstrap.
  - Implemented portal session creation for self-service subscription management.
  - Implemented subscription status API for authenticated clients.
  - Implemented billing webhook with signature verification and profile `plan_tier` synchronization (`active/trialing -> pro`, otherwise `free`).
- Frontend:
  - Connected `/pricing` upgrade CTA to real Stripe Checkout flow.
  - Added billing portal entry point and current plan/subscription status rendering.

Verification:
- Added route tests in `tests/api/billing-subscription-routes.test.mjs` for:
  - checkout auth + happy path + conflict path
  - portal missing-customer + happy path
  - subscription status payload
  - billing webhook signature guard + subscription update + checkout completion handling
- Extended Stripe mocks (`tests/mocks/stripe.mjs`, `tests/mocks/state.mjs`) to support billing primitives.
- `npm run lint`: pass (one pre-existing hook dependency warning unchanged).
- `npm test -- --runInBand`: pass (58/58).
- `npm run build`: pass with new routes included.

Resolution status:
- SaaS subscription billing baseline: Resolved.
- Remaining product tasks: plan packaging/price experiments and customer-facing billing copy tuning.

## Ideation Session (Orchestrator 4.1): Upsell Features (2026-02-26)

**Subject**: Validating "Dynamic Pricing Engine" (Enterprise) and "Quote Recovery Copilot" (Pro) as SnapQuote Upsells.

### 1. CPO (Strategy & Market Fit)
- **Market Gap**: Small trade businesses lose margin to material cost fluctuations and lose revenue to abandoned quotes (ghosting).
- **Strategy**: These are classic "Painkillers". By gating these behind Pro/Enterprise tiers, we transition SnapQuote from a "time-saver" to a "revenue-generator". The ROI for the user is mathematically guaranteed if even one quote is recovered or one margin protected.
- **Verdict**: STRONGLY APPROVED.

### 2. CTO (Technical Feasibility)
- **Feature 4 (Quote Recovery Copilot)**: 
  - *Requirements*: Need tracking pixel or read-receipt on the shared estimate link. Background cron/queue to scan for `status == 'sent'` & `updated_at < 24h` to trigger AI follow-up.
  - *Complexity*: Medium. We have SMS (Twilio) and Email (Resend) from V2. Need event triggers and LLM personalization prompt.
- **Feature 2 (Dynamic Pricing Engine)**:
  - *Requirements*: Integration with external commodity pricing APIs or regional indexes. Complex configuration UX for markup rules.
  - *Complexity*: High. Recommend starting with a "Rule-based Auto-Markup" before live commodity scraping.
- **Verdict**: FEASIBLE. Feature 4 is a quick win. Feature 2 needs strict scoping.

### 3. Marketing Lead (Virality & Hook)
- **Hook (Feature 4)**: "Stop leaving money on the table. Our AI follows up so you don't have to."
- **Hook (Feature 2)**: "Never lose margin to inflation again."
- **Verdict**: Feature 4 has strong word-of-mouth potential when a user sees an abandoned quote magically turn into a paid invoice overnight.

## Launch Planning (Reflexion)
- Agreed to proceed with API Spec generation for `TB-15` (Quote Recovery) and `TB-16` (Dynamic Pricing).

## Marketing Audit: Canbu Launch Copy (2026-02-27)

**Subject**: Authenticity Audit for the Canbu Community V1 Launch.

### 1. Strategist Context
- **Goal**: Market the current V1 core to gather early feedback without waiting for V2/V3 features.
- **Angle**: Target the 3 biggest pain points validated from the trades community: unpaid after-hours work, speed-to-lead drop-off, and fat-finger typing constraints on job sites.

### 2. Critic Audit (Anti-AI Filter)
- **Review**: The drafted Korean copy "ë” ì´ìƒ ì§‘ ì‹íƒì—ì„œ í”¼ê³¤í•œ ëª¸ìœ¼ë¡œ ê²¬ì ì„œë¥¼ ì“°ì§€ ë§ˆì„¸ìš”" (Stop doing estimates at your dining table) is grounded in reality. The copy avoids typical AI fluff words (e.g., "Elevate", "Unlock", "Synergize").
- **Verdict**: PASS. The copy is gritty, authentic, and directly addresses the physical and emotional pain points of the target audience.

## Ideation Session (Orchestrator 4.1): Post-V3 Expansion (2026-02-27)

**Subject**: Brainstorming "Painkiller" features beyond the current roadmap (V1-V3).

### 1. CPO (Strategy & Market Fit)
- **Market Gap 1 (The Supply Run)**: Estimating is only half the battle. After winning the bid, the contractor wastes hours manually translating the quote into a shopping list for Home Depot or Ferguson.
- **Market Gap 2 (The Subcontractor Chase)**: General Contractors (GCs) or Lead Plumbers often need an Electrician to finish a quote. Chasing subs for their numbers delays the final estimate to the client.
- **Market Gap 3 (Single Option Loss)**: Contractors usually quote exactly what the client asked for, missing out on massive upsell potential because building 3 different options takes too long.

### 2. CTO (Technical Feasibility)
- **Idea A: "Supply House Auto-Cart" (Material List Extraction)**
  - *Feasibility*: High. We already extract line items. We can easily prompt the LLM to output a grouped Bill of Materials (BOM) alongside the quote.
- **Idea B: "Subcontractor Whisperer" (Split Quoting)**
  - *Feasibility*: Medium-High. Requires Magic Link generation. The GC selects a line item (e.g., "Electrical panel upgrade") -> we generate an SMS link -> Electrician clicks link, enters price, and it auto-updates the GC's main quote via Supabase Realtime.
- **Idea C: "Good-Better-Best Generator" (Auto-Upsell)**
  - *Feasibility*: High. It's purely an LLM prompt engineering task. We can instruct the model to always generate 3 pricing tiers based on the initial voice input.

### 3. Marketing Lead (Virality Hook)
- **Idea A (Auto-Cart)**: "Stop wandering the aisles at Home Depot. Your quote is your shopping list."
- **Idea B (Subcontractor)**: This is a **Viral Loop**! The GC sends the link to the Electrician. The Electrician uses our platform to enter the price, experiences the UI, and becomes our next user. This is a PLG (Product-Led Growth) goldmine.
- **Idea C (Auto-Upsell)**: "Increase your average ticket size by 30% without typing a single extra word."

### 4. Verdict
- All three are exceptional.
- **Idea B (Subcontractor Whisperer)** has the highest potential for viral acquisition (B2B network effect).
- **Idea C (Good-Better-Best)** is the easiest to implement immediately (just modifying the `/api/generate` prompt).

## Ideation Session (Orchestrator 4.1): Critical Bottleneck Resolutions (2026-02-27)

**Subject**: Resolving the 4 major product bottlenecks (Onboarding Drop-off, Voice Limitations, Sync Conflicts, Feedback Blindspot).

### 1. CPO (Strategy)
- **Bottleneck 1 (Onboarding)**: The magic-link and early Stripe Connect requirement kills the "Aha!" momentum.
  - *Solution*: **Frictionless Onboarding**. Introduce Social Login (Google/Apple) and a 3-step "Setup Wizard" (Business Name, Logo, Tax Rate) immediately post-signup. Defer Stripe Connect setup until the user has generated at least 3 estimates.
- **Bottleneck 2 (Input Limits)**: Voice is great, but contractors need to upload photos of broken pipes or job sites.
  - *Solution*: **Multimodal Expansion**. Expedite TB-10 (Gemini V2). Allow image uploads alongside voice.
- **Bottleneck 3 (Sync Anxiety)**: Users fear losing data if they edit offline and try to sync later.
  - *Solution*: **CRDT Engine**. Expedite TB-12. Implement strictly deterministic merging to guarantee zero data loss.
- **Bottleneck 4 (Blindness)**: We just launched on Canbu but have no easy way for users to report bugs or request features.
  - *Solution*: **In-App Feedback Widget**. A floating button that captures screenshots and user comments, sending them directly to our database or Slack/Email.

### 2. CTO (Technical Feasibility)
- **Frictionless Onboarding (TB-17 update)**: High feasibility. Supabase provides out-of-the-box OAuth. The Setup Wizard is just a simple state machine on the frontend writing to the `profiles` table.
- **Multimodal (TB-10)**: Medium. Requires migrating the OpenAI Whisper/GPT-4o pipeline to Google Gemini API (or adding GPT-4o Vision).
- **CRDT (TB-12)**: Very High complexity. Requires implementing vector clocks and tombstoning in the Dexie offline DB and Supabase RPCs.
- **Feedback Widget (TB-18)**: High feasibility. Create a simple `POST /api/feedback` endpoint and a minimal React portal widget.

### 3. Verdict
Proceed with `/launch` for these items. Update API Spec and Task Board to lock the execution scope.

## Launch Workflow Closure: V2 Final Sign-off (2026-02-27)

Issue classification:
- Type: Program Control / Release Governance
- Priority: High
- Signal: V2 launch planning had one remaining open gate (`Final sign-off`) before implementation.

Dispatch:
- User approval received for V2 launch plan.
- Closed sign-off gate in `.agent/memory/task_board.md`.
- Locked execution priority for implementation: `TB-10` -> `TB-12` -> `TB-13`.

Critic verdict:
- **PASS**: Contract and board remain coherent after gate closure.
- No API contract delta introduced in sign-off closure step.
- Implementation continues under contract-first rule (`docs/api-spec.md` update required before any endpoint contract change).

## Develop Loop Reflexion (2026-02-27) - TB-17 Social Login (Google/Apple)

Issue classification:
- Type: Auth UX / API-Frontend integration
- Priority: High
- Signal: typed email + magic-link-only flow creates onboarding friction on job sites; V3 task TB-17 required OAuth login callback support.

## Performance Optimization Audit (2026-02-28)
- Initiated `/optimize` workflow to audit code complexity and bundle size.
- Identified heavy modular components (Modals and Charts) statically loaded on the `/` route (`app/page.tsx`).
- Refactored imports to use `next/dynamic` (`{ ssr: false }`) for components: `OnboardingModal`, `QuickQuoteModal`, `SetupWizard`, `RevenueChart`, `FunnelMetricsCard`, `UsagePlanCard`.
- **Verdict**: PASS. No behavioral side-effects. First Load JS parsing size for `/` chunk reduced by >50%.

Dispatch:
- Added OAuth entry points on `app/login/page.tsx`:
  - `Continue with Google`
  - `Continue with Apple`
  - callback redirect target wired to `/auth/callback?next=...&intent=...`
- Added callback completion screen `app/auth/callback/page.tsx`:
  - exchanges Supabase PKCE authorization code with `supabase.auth.exchangeCodeForSession(code)`
  - redirects only to normalized internal paths
  - returns OAuth provider errors to `/login` via sanitized `oauth_error`
- Added shared safety helpers `lib/auth/oauth-callback.ts`:
  - path normalization to prevent open-redirect style misuse
  - intent normalization
  - OAuth error message normalization and bounded redirect payload

Verification:
- Added tests: `tests/api/oauth-callback-utils.test.mjs`.
- Regression: `npm test` pass (63/63).
- Lint: `npm run lint` pass (single pre-existing `react-hooks/exhaustive-deps` warning unchanged).
- Build: `npm run build` failed due pre-existing filesystem loop (`ELOOP` at workspace root `GEMINI.md`), unrelated to TB-17 logic.

Critic verdict:
- **PASS (Functional)**: OAuth login flow is now implemented end-to-end under existing contract without schema drift.
- **OPEN (Environment)**: build gate remains externally blocked by `GEMINI.md` symlink loop and should be cleared before final ship.

## Scope Adjustment (2026-02-28) - TB-17 Apple Login Removal

Issue classification:
- Type: Product Scope / Auth UX simplification
- Priority: Medium
- Signal: user explicitly requested to drop Apple login from TB-17.

Dispatch:
- Updated contract language to Google-only OAuth callback handling.
- Removed Apple OAuth dispatch from `app/login/page.tsx` and retained Google OAuth + magic-link entry paths.

Verification:
- `npm test`: pass.
- `npm run lint`: pass (single pre-existing warning unchanged).

Critic verdict:
- **PASS**: scope reduction is coherent with current endpoint contract (`GET /auth/callback`) and does not introduce API behavior regression.

## Develop Loop Reflexion (2026-02-28) - TB-12 CRDT Sync Endpoint

Issue classification:
- Type: API/Data
- Priority: High
- Signal: offline concurrent edits required a durable sync journal endpoint under locked V2 contract.

Dispatch:
- Implemented `POST /api/sync/crdt` at `app/api/sync/crdt/route.ts`.
- Added strict request validation (`clientId`, `changes[]`, mutation size guards), authenticated access, and IP+user rate limiting.
- Implemented deterministic merge behavior:
  - latest `timestamp` per (`table`, `recordId`) wins
  - equal timestamps merge mutation payloads
- Persisted merged changes to `sync_change_log` with idempotent upsert conflict key:
  - `user_id, client_id, table_name, record_id, logical_ts`
- Added migration `supabase/migrations/20260228100000_add_sync_change_log_and_feedback_metadata.sql`:
  - `sync_change_log` table, indexes, constraints, RLS policies.

Verification:
- Added test coverage in `tests/api/sync-and-feedback-routes.test.mjs`:
  - unauthorized guard
  - payload validation failure
  - merge + upsert happy path
  - rate-limit rejection
- Regression: `npm test` pass (71/71).
- Lint: `npm run lint` pass (single pre-existing warning unchanged).
- Build guard: `npm run build` fails with pre-existing symlink loop (`ELOOP: GEMINI.md`) unrelated to route logic.
- CISO guard: `npm audit` blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current network-restricted environment.

Critic verdict:
- **PASS (Functional)**: endpoint behavior matches locked contract (`ok`, `mergedCount`, `serverTimestamp`) and enforces auth/rate limits.
- **Residual risk**: full CRDT conflict semantics beyond timestamp merge remain future scope (`TB-12` hardening phase).

## Launch Workflow: Phase 3 Quote Recovery Copilot (2026-03-01)

**Subject**: Strategic inception of the sales-focused expansion (TB-15).

### 1. CPO (Strategy)
- **Problem**: We have solved "Scale" (Multimodal) and "Trust" (CRDT), but we haven't solved "Revenue" (Win Rates). 
- **Solution**: The Quote Recovery Copilot turns SnapQuote from a passive tool into an active sales agent. By automating the follow-up, we provide immediate ROI to the contractor.
- **Priority**: TB-15 is the #1 priority for Phase 3.

### 2. CTO (Technical)
- **Feasibility**: High. We already have the Twilio (TB-13) and Resend (TB-03) integrations. We just need a scheduler/trigger logic and a Gemini prompt that uses the estimate's metadata to sound authentic.
- **Risk**: Over-messaging. We must ensure `followed_up_at` is updated atomically to avoid spamming homeowners.

### 3. Verdict
- Proceed with implementation. API Spec defined and task board updated.
- Verify Twilio credit balance logic before dispatching recovery SMS.
- Added endpoint tests in `tests/api/sync-and-feedback-routes.test.mjs`:
  - invalid payload
  - guest insert path
  - authenticated insert path
  - rate-limit rejection
- Regression: `npm test` pass (71/71).
- Lint: `npm run lint` pass (single pre-existing warning unchanged).
- Build guard: `npm run build` fails with pre-existing symlink loop (`ELOOP: GEMINI.md`) unrelated to TB-18 behavior.
- CISO guard: `npm audit` blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

Critic verdict:
- **PASS**: feedback ingestion now follows locked API contract (`POST /api/feedback`) with better security posture and clearer ownership boundaries.

## Develop Loop Reflexion (2026-02-28) - TB-10 Gemini Engine Switch (`POST /api/generate`)

Issue classification:
- Type: API/Data
- Priority: High
- Signal: V2 execution queue required migration of estimate generation runtime from OpenAI-only path to Gemini-capable engine while preserving output schema.

Dispatch:
- Refactored `app/api/generate/route.ts` into provider-based generation:
  - Gemini-first when `GEMINI_API_KEY` is configured (or provider forced).
  - OpenAI fallback path preserved for compatibility and controlled rollout.
- Added Gemini request/response handling:
  - system instruction + multimodal parts assembly
  - safe extraction of text JSON payload from Gemini candidates
  - prompt/completion token extraction from `usageMetadata`
- Kept contract output invariant:
  - estimate normalization (`items`, `sections`, notes, warnings)
  - quota recording and error envelope behavior.

Verification:
- Added Gemini-path test coverage in `tests/api/core-workflow-routes.test.mjs`.
- Full regression: `npm test` pass (77/77).
- Lint: `npm run lint` pass (single pre-existing warning unchanged).
- Build: `npm run build` pass after replacing workspace-root `GEMINI.md` symlink with regular file.
- CISO: `npm audit` blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current environment.

Critic verdict:
- **PASS**: endpoint contract stayed stable while engine capabilities advanced to Gemini-first execution.

## Develop Loop Reflexion (2026-02-28) - TB-13 SMS Delivery API (`POST /api/send-sms`)

Issue classification:
- Type: API/Data
- Priority: High
- Signal: V2 monetization scope required authenticated, credit-gated SMS delivery endpoint under locked contract.

Dispatch:
- Implemented `app/api/send-sms/route.ts`:
  - auth guard (`requireAuthenticatedUser`)
  - payload validation (`toPhoneNumber`, `message`, `estimateId`)
  - IP/user rate limit (20 requests / 10 min)
  - credit balance check from `sms_credit_ledger`
  - Twilio send dispatch (`TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_FROM_NUMBER`)
  - success persistence to `sms_messages` and credit deduction ledger record.

Verification:
- Added `tests/api/send-sms-routes.test.mjs`:
  - unauthorized
  - invalid payload
  - insufficient credits (402)
  - rate-limited (429)
  - successful send + ledger deduction
- Full regression: `npm test` pass (77/77).
- Lint: `npm run lint` pass (single pre-existing warning unchanged).
- Build: `npm run build` pass.
- CISO: `npm audit` blocked by DNS (`ENOTFOUND registry.npmjs.org`).

Critic verdict:
- **PASS**: runtime behavior matches locked endpoint contract and introduces minimal, test-covered provider integration risk.

## Develop Loop Reflexion (2026-02-28) - TB-15 Quote Recovery Copilot (`POST /api/quotes/recovery/trigger`)

Issue classification:
- Type: API/Data + Revenue Automation.
- Priority: High.
- Signal: sent estimates older than 48 hours had no contract-compliant runtime trigger for automated follow-up delivery.

Dispatch:
- Implemented `app/api/quotes/recovery/trigger/route.ts`.
  - Auth model: `CRON_SECRET` or authenticated Pro/Team bearer token.
  - Guardrails: IP rate limit (10 req / 1 hr), payload validation, plan-tier gating (402).
  - Candidate scan: `status='sent'` + `first_followup_queued_at is null`, then 48-hour staleness filter via `sent_at` fallback `created_at`.
  - Duplicate-send prevention: conditional claim update on `first_followup_queued_at` before dispatch.
  - Message generation: Gemini-first (`GEMINI_API_KEY`) with deterministic fallback text template.
  - Delivery routing:
    - SMS via Twilio when E.164 phone exists and SMS credits are available.
    - Email via Resend when SMS is unavailable but email exists.
    - `skipped_no_contact` when no reachable channel exists.
  - Follow-up acknowledgment: updates `first_followed_up_at` and `last_followed_up_at` on successful send.
- Added tests in `tests/api/quote-recovery-routes.test.mjs`:
  - unauthorized guard
  - Pro/Team gate (`402`)
  - dry-run planning response
  - email dispatch path
  - SMS dispatch + ledger deduction
  - no-contact skip path
  - cron-secret auth path
  - rate-limit rejection

Verification:
- `npm test`: pass (85/85).
- `npm run lint`: pass (0 warnings/errors).
- `npm run build`: pass.
- `npm audit`: blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current environment.
- Fallback static scan (`rg` on TB-15 files): no `eval`/`new Function`/unsafe HTML injection patterns detected.

Critic verdict:
- **PASS**: TB-15 contract behavior is implemented end-to-end with test coverage and anti-duplicate safeguards.
- **Residual risk**: production behavior depends on valid Twilio/Resend credentials and SMS credit provisioning.

## Strategy Shift: Phase 3.5 Auto-Upsell (2026-03-01)

**Subject**: Reprioritizing TB-19 over TB-16 for immediate ROI.

### 1. Strategy
- The user recognized the immediate upside in the "Good-Better-Best" Auto-Upsell concept discussed previously.
- TB-16 (Dynamic Pricing Engine) is deferred due to its high complexity (commodity APIs, strict UX configuration).
- TB-19 (Auto-Upsell Generator) is officially injected into the backlog and moved to execution.

### 2. Execution Path
- Modify the existing `POST /api/generate` schema to include an optional `upsellOptions` array.
- Update the Gemini prompt in `app/api/generate/route.ts` to output these options as `addedItems` representing tier upgrades ("better", "best").
- Minimal frontend changes required to visualize these upgrade options inside the estimate editor.

## Develop Loop Reflexion (2026-03-01) - TB-19 Auto-Upsell Generator (`POST /api/generate`)

Issue classification:
- Type: API/Data + Revenue UX.
- Priority: High.
- Signal: generated estimates lacked contract-specified `upsellOptions`, preventing the Good-Better-Best upsell flow from surfacing in runtime UI.

Dispatch:
- Backend/AI (`app/api/generate/route.ts`):
  - enforced normalized upsell output shape (`tier`, `title`, `description`, `addedItems`) through `normalizeUpsellOptions`.
  - filtered invalid options with empty `addedItems`.
  - kept contract-safe optional return semantics (`upsellOptions` emitted only when non-empty).
  - fixed prompt-string escaping issue so lint/build parsing remains stable.
- Frontend (`app/new-estimate/page.tsx`):
  - added payload normalization for `upsellOptions`.
  - rendered auto-upsell packages in result view with added-value preview.
  - added one-click apply action to merge selected package items into the estimate and remove applied tier from pending options.
- Data typing (`lib/estimates-storage.ts`):
  - extended `LocalEstimate` with optional `upsellOptions` for draft/sent persistence.
- Test coverage (`tests/api/core-workflow-routes.test.mjs`):
  - added assertions for upsell tier fallback normalization and invalid-package filtering.

Verification:
- `npm test`: pass (85/85).
- `npm run lint`: pass (0 warnings/errors).
- `npm run build`: pass.
- `npm audit`: blocked by DNS (`ENOTFOUND registry.npmjs.org`) in current environment.
- fallback static scan (`rg`): no `eval` / `new Function` / `dangerouslySetInnerHTML` patterns in TB-19 touched files.

Critic verdict:
- **PASS**: TB-19 is contract-compliant end-to-end (generation -> normalization -> UI exposure -> persistence) with regression coverage.
- **Residual risk**: upsell quality depends on model output quality and should be monitored with production telemetry for conversion effectiveness.
## Develop Loop Reflexion (2026-03-01) - TB-20 Auth Redirect & Sync Reliability

Issue classification:
- Type: UX / Data Integrity
- Priority: High
- Signal: users reported "hanging" screens during logout and potential data loss when switching devices with stale local storage.

Dispatch:
- **Auth Strategy**: Switched from `next/navigation` `router.push` to `window.location.href` for all authentication-gated transitions.
  - *Rationale*: Client-side routing in Next.js can sometimes be interrupted by heavy background operations (like sync or model cleanup) during an auth state change. A hard reload ensures 100% reliable state reset.
- **Sync Strategy**: Implemented "Last Write Wins" via `updatedAt` timestamps.
  - *Rationale*: Replaces the simple boolean `synced` flag which didn't account for multi-device edits. Now, the engine pulls cloud metadata first to decide if the local version is truly newer.
- **Database**: Updated IndexedDB schema and `LocalEstimate` interface to support persistent `updatedAt` tracking.

Verification:
- Manually verified logout instantly clears session and redirects to `/landing`.
- Verified sync indicator reports bidirectional transfer counts.
- `npm run lint` and `npm run build` pass.

Critic verdict:
- **PASS**: The trade-off of a "flash" on reload is a worthwhile price for 100% auth reliability in a data-heavy field app. Timestamp-based sync provides the necessary foundation for the future CRDT (TB-12) migration.

--- [ 2. The Contract (API Spec) ] ---
# API Spec: Estimate Generation and Delivery Runtime

- Project: SnapQuote
- Version: v1.1 (Hotfix + V2 Planning Addendum)
- Updated: 2026-02-28
- Base URL: `/api`
- Status: `LOCKED`

> This file is the binding runtime contract for estimate generation, delivery, and payment-link flow.
> Implementation changes must update this spec first.

---

## Authentication

- Guest or Auth:
  - `POST /api/transcribe`
  - `POST /api/generate`
  - `POST /api/send-email`
  - `POST /api/feedback`
- Auth required (`Authorization: Bearer <token>`):
  - `POST /api/create-payment-link`
  - `GET /api/payments/stripe/status`
  - `POST /api/stripe/connect/onboard`
  - `GET /api/stripe/connect/status`
  - `POST /api/stripe/connect/dashboard-link`
  - `GET /api/billing/usage`
  - `POST /api/billing/stripe/checkout`
  - `POST /api/billing/stripe/portal`
  - `GET /api/billing/subscription`
- Secret-based internal auth:
  - `POST /api/webhooks/stripe` (Stripe signature)
  - `POST /api/webhooks/stripe/billing` (Stripe signature)
  - `GET/POST /api/webhooks/stripe/reconcile` (`CRON_SECRET`)

Notes:
- `transcribe` and `generate` accept no-login traffic (`requireAuth: false` quota mode).
- If a bearer token is present on optional-auth routes, quota usage is tracked per user.

## Global Auth & Sync Management

- **Reliability Strategy**: SnapQuote uses a "Force-Reload" strategy for authentication transitions.
  - All login/logout redirects are handled by the global `AuthRedirectManager` using `window.location.href`.
  - This guarantees that the browser clears all stale state and re-initializes all providers (Supabase, Stripe) cleanly, preventing "hanging" UI bug.
- **Sync Conflict Resolution**:
  - Strategy: "Last Write Wins" (LWW) based on `updatedAt` timestamps.
  - Implementation: The `syncEstimates` engine compares local `updatedAt` against cloud metadata before performing a Push or Pull.
  - Metadata: Every estimate record MUST include an `updatedAt` ISO string. If missing, `createdAt` is the fallback.

---

## Endpoint Index

| Method | Path | Description | Auth | Contract Scope |
|:--|:--|:--|:--|:--|
| `POST` | `/api/transcribe` | Audio to text for estimate drafting | Optional | Public |
| `POST` | `/api/generate` | Generate structured estimate JSON from notes/images | Optional | Public |
| `POST` | `/api/send-email` | Send estimate email with optional PDF attachment | Optional | Public |
| `POST` | `/api/create-payment-link` | Create Stripe payment link in caller connected account | Required | Public |
| `GET` | `/api/payments/stripe/status` | Check Stripe paid status for a payment link | Required | Public |
| `POST` | `/api/stripe/connect/onboard` | Create or resume Stripe Connect onboarding | Required | Public |
| `GET` | `/api/stripe/connect/status` | Read Stripe Connect account status for caller | Required | Public |
| `POST` | `/api/stripe/connect/dashboard-link` | Create Stripe Express dashboard login link | Required | Public |
| `GET` | `/api/billing/usage` | Return plan, usage, limits, and estimated costs | Required | Internal app API |
| `POST` | `/api/billing/stripe/checkout` | Create Stripe Billing Checkout session for SaaS plan upgrade | Required | Internal app API |
| `POST` | `/api/billing/stripe/portal` | Create Stripe Customer Portal session for subscription management | Required | Internal app API |
| `GET` | `/api/billing/subscription` | Read authenticated user's SaaS subscription status | Required | Internal app API |
| `POST` | `/api/webhooks/stripe` | Mark estimate paid from Stripe checkout completion | Stripe signature | Internal ops API |
| `POST` | `/api/webhooks/stripe/billing` | Apply Stripe Billing subscription events to plan tier/status | Stripe signature | Internal ops API |
| `GET/POST` | `/api/webhooks/stripe/reconcile` | Backfill paid sessions and reconcile estimate status | `CRON_SECRET` | Internal ops API |
| `POST` | `/api/sync/crdt` | CRDT-based offline state synchronization | Required | Internal app API |
| `POST` | `/api/send-sms` | Premium SMS delivery via Twilio (Pay-as-you-go) | Required | Internal app API |
| `POST` | `/api/feedback` | Collect in-app bug/feature/general feedback | Optional | Internal app API |
| `POST` | `/api/quotes/recovery/trigger` | Trigger Quote Recovery AI Copilot | Required | Internal app API |
| `POST` | `/api/pricing/dynamic/calculate` | Calculate dynamic pricing markup based on indices | Required | Internal app API |
| `GET` | `/auth/callback` | Handle Supabase OAuth (Google) PKCE code exchange | N/A | Public |

---

## Shared Types

```typescript
interface StructuredError {
  error: {
    message: string;
    code: number;
  };
}

interface StringError {
  error: string;
}

interface QuotaError {
  error: string;
  code: "FREE_PLAN_LIMIT_REACHED" | "UNAUTHORIZED" | "USAGE_CONTEXT_ERROR";
  metric: "generate" | "transcribe" | "send_email";
  usage?: number;
  limit?: number;
}
```

---

## 1) POST /api/transcribe

Purpose: transcribe recorded trade field notes to text.

Rate limit: 40 requests / 10 min / IP.

Request (`multipart/form-data`):
- `file: File` (`audio/*`, max `20MB`)

Response `200`:

```typescript
interface TranscribeResponse {
  text: string;
}
```

Error responses:
- `400`: invalid/missing file
- `402`: free quota limit reached
- `413`: file too large
- `429`: rate limited
- `500`: transcription failure

```typescript
type TranscribeErrorResponse = StringError | QuotaError;
```

---

## 2) POST /api/generate

Purpose: generate estimate JSON from notes and optional images.

Rate limit: 20 requests / 10 min / IP.

Request (`application/json`):

```typescript
interface GenerateEstimateRequest {
  images?: string[]; // max 8 items, each string <= 2_000_000 chars
  notes?: string; // max 8000 chars
  projectType?: "residential" | "commercial";
  userProfile?: {
    city?: string;
    country?: string;
    taxRate?: number;
    businessName?: string;
    priceList?: string;
  };
}
```

Response `200`:

```typescript
interface EstimateItem {
  id: string;
  itemNumber: number;
  category: string;
  description: string;
  quantity: number;
  unit: string;
  unit_price: number;
  total: number;
}

interface EstimateSection {
  id: string;
  name: string;
  divisionCode?: string;
  items: EstimateItem[];
}

interface UpsellOption {
  tier: "better" | "best";
  title: string;
  description: string;
  addedItems: EstimateItem[];
}

interface EstimateResponse {
  items: EstimateItem[];
  sections?: EstimateSection[];
  summary_note: string;
  payment_terms?: string; // runtime may return empty string when not provided
  closing_note?: string; // runtime may return empty string when not provided
  warnings?: string[];
  upsellOptions?: UpsellOption[]; // [Architecture V3.5] Auto-generated upgrade packages
}
```

Error responses:
- `400`: invalid notes/images payload
- `402`: free quota limit reached
- `429`: rate limited
- `500`: model/server failure

```typescript
type GenerateErrorResponse = StringError | QuotaError;
```

---

## 3) POST /api/send-email

Purpose: deliver estimate email with optional PDF attachment.

Rate limit: 30 requests / 10 min / IP.

Request (`application/json`):

```typescript
interface SendEmailRequest {
  email?: string; // alias for "to"
  to?: string;
  subject?: string;
  message?: string;
  filename?: string;
  businessName?: string;
  clientName?: string;
  referralUrl?: string; // http/https only
  pdfBase64?: string; // alias for "pdfBuffer"
  pdfBuffer?: string;
}
```

Success `200`:

```typescript
interface SendEmailSuccessResponse {
  success: true;
  data: unknown;
}

interface SendEmailMailtoFallbackResponse {
  method: "mailto";
  mailtoUrl: string;
  message: string;
}
```

Error responses:
- `400`: invalid email/body or Resend API error
- `402`: quota reached (`send_email`)
- `413`: PDF too large (`>10MB`)
- `429`: rate limited
- `500`: internal failure

```typescript
type SendEmailErrorResponse =
  | StructuredError
  | StringError
  | {
      success: false;
      error: string;
    }
  | (QuotaError & { metric: "send_email" });
```

---

## 4) POST /api/create-payment-link

Purpose: create Stripe payment link for one estimate payment.

Rate limit: 30 requests / 10 min / IP.

Request (`application/json`):

```typescript
interface CreatePaymentLinkRequest {
  amount: number; // > 0 and <= 500000
  customerName?: string; // max 120 chars
  estimateNumber?: string; // max 80 chars
  estimateId?: string; // uuid format when provided
}
```

Optional request header:
- `Idempotency-Key: <string>` (max 255 chars)
- If omitted, server generates a deterministic key from `userId + estimateId/estimateNumber + amount`.

Operational note:
- Stripe payment link is created under the caller Stripe connected account (`profiles.stripe_account_id`).
- Stripe payment link completion redirects to `${NEXT_PUBLIC_APP_URL}/payment-success?estimateId=...&estimateNumber=...`.

Success `200`:

```typescript
interface CreatePaymentLinkResponse {
  url: string; // Stripe hosted URL
  id: string; // Stripe payment link id
}
```

Error responses:
- `400`: invalid amount/estimateId
- `401`: unauthorized or Stripe authentication error
- `403`: Stripe Connect not linked or onboarding incomplete
- `429`: rate limited
- `500`: Stripe not configured/internal failure

```typescript
type CreatePaymentLinkErrorResponse = StructuredError | StringError;
```

---

## 5) GET /api/payments/stripe/status

Purpose: check Stripe payment completion for a payment link to sync local estimate status for authenticated users.

Rate limit: 60 requests / 10 min / IP.

Query:

```typescript
interface StripePaymentStatusQuery {
  paymentLinkId: string; // required, Stripe payment link id (e.g. plink_xxx)
  estimateId?: string; // optional uuid to enforce estimate match
  estimateNumber?: string; // optional estimate number to enforce estimate match
}
```

Response `200`:

```typescript
interface StripePaymentStatusResponse {
  ok: true;
  paid: boolean;
  checkoutSessionId?: string;
  paidAt?: string; // ISO datetime
  estimateId?: string;
  estimateNumber?: string;
}
```

Error responses:
- `400`: invalid/missing query values
- `401`: Stripe authentication error
- `429`: rate limited
- `500`: Stripe not configured/internal failure

```typescript
type StripePaymentStatusErrorResponse = StructuredError | StringError;
```

---

## 6) POST /api/stripe/connect/onboard

Purpose: create or resume Stripe Connect Express onboarding for the authenticated business owner.

Rate limit: 20 requests / 10 min / IP.

Request: no body.

Response `200`:

```typescript
interface StripeConnectOnboardResponse {
  url: string; // Stripe onboarding URL
  accountId: string; // Stripe connected account id (acct_*)
}
```

Error responses:
- `401`: unauthorized
- `500`: Stripe/Supabase configuration or provider failure

```typescript
type StripeConnectOnboardErrorResponse = StructuredError | StringError;
```

---

## 7) GET /api/stripe/connect/status

Purpose: retrieve Stripe connected account status for the authenticated business owner.

Rate limit: 60 requests / 10 min / IP.

Request: no body.

Response `200`:

```typescript
interface StripeConnectStatusResponse {
  connected: boolean;
  accountId?: string;
  detailsSubmitted?: boolean;
  chargesEnabled?: boolean;
  payoutsEnabled?: boolean;
}
```

Error responses:
- `401`: unauthorized
- `500`: Stripe/Supabase configuration or provider failure

```typescript
type StripeConnectStatusErrorResponse = StructuredError | StringError;
```

---

## 8) POST /api/stripe/connect/dashboard-link

Purpose: create a Stripe Express dashboard login link for the authenticated business owner.

Rate limit: 20 requests / 10 min / IP.

Request: no body.

Response `200`:

```typescript
interface StripeConnectDashboardLinkResponse {
  url: string; // Stripe Express dashboard login URL
}
```

Error responses:
- `401`: unauthorized
- `403`: Stripe Connect not linked yet
- `500`: Stripe/Supabase configuration or provider failure

```typescript
type StripeConnectDashboardLinkErrorResponse = StructuredError | StringError;
```

---

## 9) GET /api/billing/usage

Purpose: return current monthly quota usage and estimated cost data.

Request: no body.

Response `200`:

```typescript
interface BillingUsageResponse {
  planTier: "free" | "starter" | "pro" | "team";
  periodStart: string; // YYYY-MM-DD (UTC month start)
  usage: {
    generate: number;
    transcribe: number;
    send_email: number;
  };
  limits: {
    generate: number;
    transcribe: number;
    send_email: number;
  };
  remaining: {
    generate: number;
    transcribe: number;
    send_email: number;
  };
  usageRatePct: {
    generate: number;
    transcribe: number;
    send_email: number;
  };
  openaiPromptTokens: number;
  openaiCompletionTokens: number;
  estimatedCosts: {
    openai: number;
    resend: number;
    total: number;
  };
}
```

Error responses:
- `401`: unauthorized
- `429`: rate limited
- `500`: usage context/configuration failure

```typescript
type BillingUsageErrorResponse = {
  error: {
    message: string;
    code: number;
  };
};
```

---

## 10) POST /api/webhooks/stripe (Operational)

Purpose: apply Stripe payment success events to estimate status.

Auth: Stripe signature (`stripe-signature` header + webhook secret).

Accepted event types:
- `checkout.session.completed`
- `checkout.session.async_payment_succeeded`

Behavior:
- Resolve `estimateId` and fallback by `estimateNumber` metadata.
- Update `estimates.status` to `paid`.
- Emit `analytics_events` with `event_name = payment_completed`.

Success:
- `200` plain text: `Received`

Errors:
- `400`: signature/malformed event
- `500`: server configuration or DB update failure

---

## 11) GET/POST /api/webhooks/stripe/reconcile (Operational)

Purpose: reconcile missed Stripe webhook updates for recent paid sessions.

Auth:
- `Authorization: Bearer <CRON_SECRET>` or `x-cron-secret: <CRON_SECRET>`

Query:
- `lookbackHours?: number` (default `72`, max `720`)

Response `200`:

```typescript
interface StripeReconcileResponse {
  ok: true;
  lookbackHours: number;
  capped: boolean;
  scanned: number;
  paidSessions: number;
  matched: number;
  updated: number;
  alreadyPaid: number;
  missingMetadata: number;
  missingEstimate: number;
  errors: number;
}
```

Errors:
- `401`: unauthorized
- `500`: missing config/internal failure

---

## 12) POST /api/sync/crdt (Architecture V2)

Purpose: Handle Conflict-Free Replicated Data Type synchronization to prevent data loss on concurrent offline edits.

Auth: Required.
Rate limit: 30 requests / 10 min / IP.

Request (`application/json`):
```typescript
interface SyncCRDTRequest {
  clientId: string;
  changes: Array<{
    table: string;
    recordId: string;
    timestamp: number;
    mutations: Record<string, any>;
  }>;
}
```

Response `200`:
```typescript
interface SyncCRDTResponse {
  ok: true;
  mergedCount: number;
  serverTimestamp: number;
}
```

Error responses:
- `400`: invalid clientId/change payload
- `401`: unauthorized
- `429`: rate limited
- `500`: sync engine/storage failure

```typescript
type SyncCRDTErrorResponse = StructuredError | StringError;
```

---

## 13) POST /api/send-sms (Architecture V2 Premium)

Purpose: Send SMS updates (e.g., Follow-ups) using pay-as-you-go credits via Twilio.

Auth: Required (Must have SMS credits > 0).
Rate limit: 20 requests / 10 min / IP.

Request (`application/json`):
```typescript
interface SendSMSRequest {
  toPhoneNumber: string;
  message: string;
  estimateId: string;
}
```

Response `200`:
```typescript
interface SendSMSResponse {
  ok: true;
  messageId: string;
  creditsRemaining: number;
}
```

Error responses:
- `400`: invalid phone/message payload
- `401`: unauthorized
- `402`: insufficient SMS credits
- `429`: rate limited
- `500`: provider/configuration failure

```typescript
type SendSMSErrorResponse = StructuredError | StringError;
```

---

## 14) POST /api/billing/stripe/checkout

Purpose: create Stripe Billing Checkout session for SaaS subscription upgrade.

Auth: Required.
Rate limit: 20 requests / 10 min / IP.

Request (`application/json`):

```typescript
interface BillingCheckoutRequest {
  planTier?: "starter" | "pro" | "team"; // defaults to "pro"
  priceId?: string; // optional override; must match selected plan tier configured billing price
  successPath?: string; // defaults to "/pricing?checkout=success"
  cancelPath?: string; // defaults to "/pricing?checkout=cancel"
}
```

Response `200`:

```typescript
interface BillingCheckoutResponse {
  url: string; // Stripe hosted checkout URL
  sessionId: string; // Stripe checkout session id
  customerId: string; // Stripe customer id linked to user profile
  planTier: "starter" | "pro" | "team";
}
```

Error responses:
- `400`: invalid planTier/priceId/path payload
- `401`: unauthorized
- `409`: active/trialing subscription already exists
- `429`: rate limited
- `500`: Stripe/Supabase configuration or provider failure

```typescript
type BillingCheckoutErrorResponse = StructuredError | StringError;
```

---

## 15) POST /api/billing/stripe/portal

Purpose: create Stripe Customer Portal session for authenticated SaaS subscribers.

Auth: Required.
Rate limit: 20 requests / 10 min / IP.

Request: no body.

Response `200`:

```typescript
interface BillingPortalResponse {
  url: string; // Stripe customer portal URL
}
```

Error responses:
- `401`: unauthorized
- `403`: no Stripe billing customer is linked to caller
- `429`: rate limited
- `500`: Stripe/Supabase configuration or provider failure

```typescript
type BillingPortalErrorResponse = StructuredError | StringError;
```

---

## 16) GET /api/billing/subscription

Purpose: return caller SaaS subscription status and billing linkage fields.

Auth: Required.
Rate limit: 60 requests / 10 min / IP.

Response `200`:

```typescript
interface BillingSubscriptionStatusResponse {
  ok: true;
  planTier: "free" | "starter" | "pro" | "team";
  subscribed: boolean;
  status:
    | "active"
    | "trialing"
    | "past_due"
    | "canceled"
    | "incomplete"
    | "incomplete_expired"
    | "unpaid"
    | "paused"
    | null;
  customerId?: string;
  subscriptionId?: string;
  priceId?: string;
  currentPeriodEnd?: string; // ISO datetime
  cancelAtPeriodEnd: boolean;
}
```

Error responses:
- `401`: unauthorized
- `429`: rate limited
- `500`: Supabase configuration or internal failure

```typescript
type BillingSubscriptionStatusErrorResponse = StructuredError | StringError;
```

---

## 17) POST /api/webhooks/stripe/billing (Operational)

Purpose: apply Stripe Billing events to SaaS subscription state and `profiles.plan_tier`.

Auth: Stripe signature (`stripe-signature` header + `STRIPE_BILLING_WEBHOOK_SECRET`).

Accepted event types:
- `checkout.session.completed` (subscription mode)
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `invoice.payment_failed`

Behavior:
- Resolve target user by `metadata.userId`, `client_reference_id`, or `profiles.stripe_customer_id`.
- Persist billing linkage in `profiles` (`stripe_customer_id`, `stripe_subscription_*` fields).
- Set `profiles.plan_tier` from subscription plan mapping (`starter`/`pro`/`team`) for `active/trialing`, otherwise downgrade to `free`.

Success:
- `200` plain text: `Received`

Errors:
- `400`: signature/malformed event
- `500`: missing config/internal failure

---

## 18) POST /api/quotes/recovery/trigger (Architecture V3 Pro)

Purpose: Identify and follow up on "warm" leads (quotes sent but not paid after 48 hours) using AI-generated messaging.

Auth: Required (`CRON_SECRET` or Pro/Team `Bearer` token).
Rate limit: 10 requests / 1 hr / IP.

Request (`application/json`):
```typescript
interface RecoveryTriggerRequest {
  estimateId?: string; // Optional: trigger for a specific estimate only
  dryRun?: boolean;   // Optional: return plan without sending messages
}
```

Response `200`:
```typescript
interface RecoveryTriggerResponse {
  ok: true;
  processedCount: number;
  results: Array<{
    estimateId: string;
    estimateNumber: string;
    action: "sent_sms" | "sent_email" | "skipped_no_contact";
    messagePreview: string;
  }>;
}
```

Error responses:
- `401`: unauthorized (invalid secret)
- `402`: requires Pro/Team tier upgrade
- `429`: rate limited
- `500`: AI generation or delivery provider failure

```typescript
type RecoveryTriggerErrorResponse = StructuredError | StringError | QuotaError;
```

---

## 19) POST /api/pricing/dynamic/calculate (Architecture V3 Enterprise - [BACKLOG])

Purpose: Calculate recommended estimate totals dynamically based on real-time material indices and user margin rules.

Auth: Required (Must be on Enterprise/Team tier).
Rate limit: 20 requests / 10 min / IP.

Request (`application/json`):
```typescript
interface DynamicPricingRequest {
  estimateId: string;
  region: string;
  baseMarginPct: number;
}
```

Response `200`:
```typescript
interface DynamicPricingResponse {
  ok: true;
  originalTotal: number;
  recommendedTotal: number;
  marketIndexRatio: number;
  appliedMarginPct: number;
  itemsAdjusted: Array<{
    itemId: string;
    newUnitPrice: number;
  }>;
}
```

Error responses:
- `400`: invalid payload
- `401`: unauthorized
- `402`: requires Enterprise tier upgrade
- `404`: estimate not found
- `429`: rate limited
- `500`: pricing index provider failure

```typescript
type DynamicPricingErrorResponse = StructuredError | StringError;
```

---

## 20) POST /api/feedback (Architecture V2)

Purpose: Allow users (even unauthenticated) to submit bug reports, feature requests, or general feedback directly from the app.

Auth: Optional.
Rate limit: 10 requests / 1 hr / IP.

Request (`application/json`):
```typescript
interface FeedbackRequest {
  type: "bug" | "feature" | "general";
  message: string;
  metadata?: Record<string, any>; // e.g., browser info, screen context
}
```

Response `200`:
```typescript
interface FeedbackResponse {
  ok: true;
  id: string;
}
```

Error responses:
- `400`: invalid payload
- `429`: rate limited
- `500`: database failure

---

## Error Code Matrix

| Code | Meaning | Common Endpoints |
|:--|:--|:--|
| `400` | bad request payload or validation failure | transcribe, generate, send-email, create-payment-link, payments/stripe/status, billing/stripe/checkout, webhook, sync/crdt, send-sms, feedback |
| `401` | missing/invalid auth or provider auth issue | create-payment-link, payments/stripe/status, stripe/connect/*, billing/usage, billing/subscription, billing/stripe/*, reconcile, sync/crdt, send-sms |
| `402` | plan quota exceeded or insufficient credits | transcribe, generate, send-email, send-sms |
| `403` | authenticated but action not allowed (connect not linked/incomplete or billing customer missing) | create-payment-link, stripe/connect/dashboard-link, billing/stripe/portal |
| `409` | request conflicts with existing active state | billing/stripe/checkout (already subscribed) |
| `413` | payload too large | transcribe, send-email |
| `429` | rate limit exceeded | public runtime endpoints + billing/* + sync/crdt + send-sms + feedback |
| `500` | server/config/provider failure | all endpoints |

---

## Database Tables (Runtime Relevant)

| Table | Key Columns | Used By | RLS |
|:--|:--|:--|:--|
| `profiles` | `id`, `plan_tier`, `stripe_account_id`, `stripe_*_enabled`, `stripe_customer_id`, `stripe_subscription_*` | quota plan resolution + Stripe Connect + SaaS billing mapping | Yes |
| `usage_counters_monthly` | `user_id`, `period_start`, usage/cost counters | quota enforcement and usage API | Yes |
| `estimates` | `id`, `user_id`, `estimate_number`, `status` | payment link metadata target and paid transition | Yes (service role bypass for webhook) |
| `analytics_events` | `user_id`, `event_name`, `estimate_id`, `external_id` | quota milestones and payment conversion events | Yes (service role bypass for webhook) |
| `ops_alerts` | `source`, `severity`, `alert_key`, `context` | operational alerts for webhook/reconcile failures | Yes |
| `sync_change_log` | `user_id`, `client_id`, `table_name`, `record_id`, `logical_ts`, `payload` | CRDT/vector-clock change merge journal | Yes |
| `feedback` | `id`, `user_id`, `category`, `description`, `metadata` | in-app feedback capture and triage workflow | Yes |
| `sms_credit_ledger` | `user_id`, `delta_credits`, `reason`, `ref_id` | SMS pay-as-you-go credit balance accounting | Yes |
| `sms_messages` | `user_id`, `estimate_id`, `to_phone_e164`, `provider_id`, `status` | outbound SMS delivery and audit trail | Yes |

---

## Task Mapping Verification

| Task Board ID | Endpoint Mapping | Verification |
|:--|:--|:--|
| `TB-01` | `POST /api/transcribe` | mapped |
| `TB-02` | `POST /api/generate` | mapped |
| `TB-03` | `POST /api/send-email` | mapped |
| `TB-04` | `POST /api/create-payment-link` | mapped |
| `TB-05` | `POST /api/webhooks/stripe` | mapped |
| `TB-06` | `GET/POST /api/webhooks/stripe/reconcile` | mapped |
| `TB-07` | `GET /api/billing/usage` | mapped |
| `TB-08` | `POST /api/stripe/connect/onboard`, `GET /api/stripe/connect/status`, `POST /api/stripe/connect/dashboard-link` | mapped |
| `TB-09` | `GET /api/payments/stripe/status` | mapped |
| `TB-10` | `POST /api/generate` (Switching to Gemini) | mapped |
| `TB-11` | N/A (Build config) | mapped |
| `TB-12` | `POST /api/sync/crdt` | mapped |
| `TB-13` | `POST /api/send-sms` | mapped |
| `TB-14` | `POST /api/billing/stripe/checkout`, `POST /api/billing/stripe/portal`, `GET /api/billing/subscription`, `POST /api/webhooks/stripe/billing` | mapped |
| `TB-15` | `POST /api/quotes/recovery/trigger` | mapped |
| `TB-16` | `POST /api/pricing/dynamic/calculate` | mapped |
| `TB-17` | `GET /auth/callback` | mapped |
| `TB-18` | `POST /api/feedback` | mapped |

All tasks in `.agent/memory/task_board.md` map to at least one endpoint in this document.

---

## Operational Notes

- Client PDF generation uses direct module import and `pdf(...).toBlob()` to avoid runtime interop crashes.
- Preview/download and send-email flows share one document-creation pattern to minimize divergence.
- Payment link metadata contract for downstream settlement:
  - `estimateId`
  - `estimateNumber`
  - `userId` (required)
- Stripe Connect account mapping is stored in `profiles.stripe_account_id` and must be linked before payment-link creation.
- SaaS billing is platform-owned and separated from tenant quote payments:
  - tenant quote payment: Stripe Connect (`/api/create-payment-link`)
  - SaaS subscription: Stripe Billing (`/api/billing/stripe/*`, `/api/webhooks/stripe/billing`)
- SaaS subscription price mapping env keys:
  - `STRIPE_BILLING_PRICE_STARTER_MONTHLY`
  - `STRIPE_BILLING_PRICE_PRO_MONTHLY`
  - `STRIPE_BILLING_PRICE_TEAM_MONTHLY`
- V2 rollout status:
  - `/api/generate`: Gemini-capable runtime active (Gemini-first with OpenAI fallback compatibility)
  - `/api/sync/crdt`: implemented (runtime + tests)
  - `/api/feedback`: implemented (runtime + widget wiring + tests)
  - `/api/send-sms`: implemented (runtime + tests)

--- [ 2.1 Project Context (Conductor) ] ---
CONTEXT: conductor/product.md
# ðŸ“¦ Product Strategy: Project Conductor

Define the core vision and product requirements here.

## Overview
This project is an AI-orchestrated development environment.

## Target Audience
AI Engineers and Developers using Agentic Workflows.

## Core Features
1. Orchestrator 4.0 Engine.
2. Parallel Implementation Threads.
3. Multi-Model Routing.

CONTEXT: conductor/tech-stack.md
# ðŸ’» Technology Stack

## Frontend
- React / Next.js
- Tailwind CSS / Vanilla CSS

## Backend
- Supabase (PostgreSQL, Edge Functions)
- Node.js

## Infrastructure
- Vercel (Deployment)
- Git (Version Control)

CONTEXT: conductor/tracks.md
# Engineering Tracks

## 2026-02-20 - Fix Loop: Dependency Security Patch

- Scope: `npm audit` vulnerability remediation for high-risk dependency paths.
- Actions:
  - Replaced `xlsx` import path with CSV parser.
  - Removed `next-pwa` wrapper and moved to manual service worker registration.
  - Added Next image optimizer hardening.
- QA:
  - `npm test`: pass (36/36)
  - `npm run lint`: pass (1 pre-existing warning)
  - `npm prune`: pass (`next-pwa`/`xlsx` removed from installed tree)
- Status: In progress for full lockfile re-resolution and Next major upgrade planning.

## 2026-02-25 - Fix Loop: Database Security Patch

- Scope: Static schema audit remediation (missing BK/FK indexes and RLS policies).
- Actions:
  - Added B-Tree indexes for critical foreign keys (`estimate_items`, `automations`, `job_queue`, `feedback`).
  - Restricted `referral_events` public insert vector to Service Role only.
  - Relaxed `pricing_experiments` read policy to public for pre-login A/B testing.
- QA:
  - Validated structural integrity of `supabase_schema_fresh.sql` and legacy `supabase_schema.sql`.
- Status: Ready to be applied to remote via `supabase db push`.


--- [ 2.5 Multi-Skill Library ] ---

--- [ 3. The Rules (Workflow) ] ---
---
description: Autonomous Development Loop (Orchestrator 4.1)
---

# âš™ï¸ Develop (Agentic Factory v4.1)

Self-driving development engine with **Parallel Implementation** and **Specialist Dispatch**.

## 0. [AGENT] Orchestrator: Intelligence Setup
- [ ] **Model Router**: Analyze task complexity.
    - `[LIGHT]` â†’ Recommend Flash/mini model.
    - `[HEAVY]` â†’ Recommend Pro/Sonnet model.
- [ ] **Skill Discovery**: Scan codebase for tech signals and auto-load matching skills from `.agent/skills/`.
- [ ] **Contract Check**: Verify `docs/api-spec.md` exists.
    - âœ… Found â†’ Load spec and use as the binding contract for all implementation.
    - âŒ Not Found â†’ **HALT. Print: "âš ï¸ Contract Missing. Run `/launch` first to generate API Spec."** Do NOT proceed.
- [ ] **Board Init**: Update `.agent/memory/task_board.md` with mission, agents, and recommended model.

## 1. [AGENT] Parallel Implementation (P4) âš¡

> **Factory Rule**: Both threads reference `docs/api-spec.md` as the single source of truth.
> If the project is frontend-only or backend-only, skip the irrelevant thread.

### Thread A: Backend (API Builder)

**Input**: `docs/api-spec.md` â†’ **Output**: Working API endpoints

| Step | Action | Validation |
|:-----|:-------|:-----------|
| A1 | Read ALL endpoints from `docs/api-spec.md` | - |
| A2 | Implement each endpoint (route, handler, DB query) | - |
| A3 | Validate: Every response MUST match the spec's TypeScript schema | Type check |
| A4 | Write endpoint tests (1 test per endpoint minimum) | `npm test` |

**Skills Auto-Loaded**: `nextjs-supabase-auth`, `api-design-principles`, `clean-code`, `supabase-automation`, `typescript-expert`
**Output Checkpoint**: All endpoints return correct schema. Tests pass.

---

### Thread B: Frontend (UI Builder)

**Input**: `docs/api-spec.md` â†’ **Output**: Working UI with mock data

| Step | Action | Validation |
|:-----|:-------|:-----------|
| B1 | Create `src/mocks/api-mocks.ts` â€” mock responses matching spec schemas | Type check |
| B2 | Build pages/components using `fsd-lite` folder structure | - |
| B3 | Wire UI to mock data (fetch from `api-mocks.ts`) | Visual check |
| B4 | Apply `anti-ai-design` + `modern-css-patterns` for premium look | UI review |

**Skills Auto-Loaded**: `react-best-practices` (Vercel 45-Rule), `nextjs-app-router-patterns`, `nextjs-best-practices`, `fsd-lite`, `anti-ai-design`, `tailwind-design-system`, `zustand-store-ts`
**Output Checkpoint**: UI renders correctly with mock data. No hardcoded values.

---

### Phase: Integration (Thread A + B Merge)

> **This phase begins ONLY after both Thread A and Thread B checkpoints pass.**

| Step | Action | Validation |
|:-----|:-------|:-----------|
| I1 | Replace `api-mocks.ts` imports with real API calls | - |
| I2 | Run **Contract Test**: Compare actual API responses vs `docs/api-spec.md` | Schema match |
| I3 | Run full E2E flow using `e2e-testing-patterns`: Create â†’ Read â†’ Update â†’ Delete | Functional check |
| I4 | If mismatch found â†’ Log to `agent_debate.md` and fix | - |

**Gate**: Integration is COMPLETE only when Contract Test passes 100%.


## 2. [AGENT] Critic: Reflexion Loop
- [ ] **Review**: Audit code against `api-spec.md` contract and skill standards.
- [ ] **Debate**: Record all critique in `.agent/memory/agent_debate.md` (IN ENGLISH).
- [ ] **Reiterate**: If rejected, Lead Dev must refactor until approved.

## 3. [AGENT] Specialist Dispatch (P7) ðŸŽ¯

> **Rule**: Do NOT generic-fix. Diagnose first, then dispatch the right specialist.

### Step 1: Diagnose (Error Classification)

Read the Critic's feedback from `agent_debate.md` and classify each issue:

| Signal (í‚¤ì›Œë“œ) | Error Type | Priority |
|:---------------|:-----------|:--------:|
| `layout`, `spacing`, `color`, `font`, `responsive` | **UI/CSS** | ðŸŸ¡ Medium |
| `endpoint`, `404`, `500`, `schema mismatch`, `CORS` | **API/Data** | ðŸ”´ High |
| `XSS`, `injection`, `auth bypass`, `token leak` | **Security** | ðŸ”´ Critical |
| `slow`, `re-render`, `bundle size`, `memory leak` | **Performance** | ðŸŸ¡ Medium |
| `query`, `migration`, `RLS`, `foreign key`, `deadlock` | **Database** | ðŸ”´ High |
| `TypeError`, `undefined`, `null`, `any`, `lint` | **Type/Quality** | ðŸŸ¢ Low |

### Step 2: Dispatch (Specialist Loading)

Load the matching skill and apply its rules to fix the issue:

| Error Type | Dispatched Skill | Action |
|:-----------|:-----------------|:-------|
| UI/CSS | `anti-ai-design` + `modern-css-patterns` | Restyle component |
| API/Data | `api-design-principles` + `api-spec-template` | Fix endpoint, re-validate vs spec |
| Security | `vulnerability-scanner` + `api-security-best-practices` | Full scan + patch |
| Performance | `performance-optimization` | Profile + optimize |
| Database | `nextjs-supabase-auth` + `supabase-automation` | Fix query/RLS/migration |
| Database (Plan B) | `neon-postgres` + `clerk-auth` | Neon/Clerk fallback |
| Type/Quality | `clean-code` (Uncle Bob) + `typescript-expert` | Refactor + lint |

### Step 3: Verify (Post-Fix Gate)

- [ ] Re-run the Critic's original test case.
- [ ] If PASS â†’ Mark issue as resolved in `agent_debate.md`.
- [ ] If FAIL â†’ Re-dispatch (max 2 retries, then escalate to user).

> [!WARNING]
> **Security issues (ðŸ”´ Critical)** must be fixed BEFORE any other issue type.
> Never ship code with unresolved Security dispatches.

## 4. [AGENT] Secretary: Bilingual Documentation
- [ ] **History (EN)**: Append feature record to `.agent/memory/feature_history_en.md`.
- [ ] **History (KR)**: Append feature record to `.agent/memory/feature_history_kr.md`.

## 5. [AGENT] QA & CISO: Final Guard
- [ ] **QA**: Run full regression suite.
- [ ] **CISO Scan**: Execute `vulnerability-scanner`.
- [ ] **Handover**: Signal "Ready for Ship" only if 100% green.

---
> [!IMPORTANT]
> **Contract-First**: If `docs/api-spec.md` does not exist, run `/launch` first.
> **Language Protocol**: Agent debate = English. User reports = Korean.

## [AGENT] Secretary: Daily Log
- [ ] **Log**: Append summary to `.agent/memory/daily/YYYY-MM-DD.md`.
  - Workflow name, timestamp, files changed count.
  - Key decision (1-2 sentences).
  - Tomorrow's TODO (if applicable).

--- [ 4. Instructions ] ---
Please execute the current step marked in [ 1. The Mission ].
Follow the rules in [ 3. The Rules ] strictly.
If writing code, adhere to [ 2. The Contract ].
